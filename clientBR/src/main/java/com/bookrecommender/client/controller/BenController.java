package com.bookrecommender.client.controller;import java.io.IOException;import java.rmi.RemoteException;import java.time.LocalDate;import java.util.HashMap;import java.util.List;import java.util.stream.Collectors;import com.bookrecommender.common.dto.Book;import com.bookrecommender.common.enums.suggestion.AddSuggestionResult;import javafx.beans.value.ChangeListener;import javafx.beans.value.ObservableValue;import javafx.collections.FXCollections;import javafx.event.ActionEvent;import javafx.fxml.FXML;import javafx.scene.control.*;import javafx.scene.layout.VBox;public class BenController {    @FXML private VBox buttonList;    @FXML private Button btnAcc, btnReg;    //bottoni che appaiono nella sezione ospite    @FXML private Button btnCreaLib, btnRicercaLib, btnLeTueLib, btnLogout, btnRitorno; //bottoni che appaiono nella sezione registrato    @FXML private TextField tfRicerca;    @FXML private TextField tfRicercaAnno;    @FXML private SplitMenuButton tipiDiRicerca;    @FXML private Label listLabel, errorLabel;    @FXML private ListView<String> listaLibri;    @FXML private Button btnInfoLibro, btnConsigliaLibro;    public static Book libro;    private HashMap<String, Book> ricercaLibriMap = new HashMap<>();    @FXML    private void initialize()    {        btnInfoLibro.setVisible(false);        if(LoginController.user == Utente.REGISTRATO)        {            listLabel.setText("registrato");            buttonList.getChildren().removeAll(btnAcc, btnReg);        }        else        {            listLabel.setText("ospite");            buttonList.getChildren().removeAll(btnCreaLib, btnRicercaLib, btnLeTueLib,btnLogout, btnRitorno);        }        if(LibreriaController.consigliando)        {            buttonList.getChildren().removeAll(btnCreaLib, btnRicercaLib, btnLeTueLib,btnLogout);        }        else        {            buttonList.getChildren().removeAll(btnRitorno);        }    }    private enum TipoDiRicerca {        TITOLO,        AUTORE,        AUTORE_E_ANNO    }    private TipoDiRicerca tipoDiRicerca = TipoDiRicerca.TITOLO;    //sezione per la selezione del tipo di ricerca    @FXML    void ricercaAutore(ActionEvent event)    {        tipoDiRicerca = TipoDiRicerca.AUTORE;        tipiDiRicerca.setText("Autore");        tfRicercaAnno.setDisable(true);    }    @FXML    void ricercaTitolo(ActionEvent event)    {        tipoDiRicerca = TipoDiRicerca.TITOLO;        tipiDiRicerca.setText("Titolo");        tfRicercaAnno.setDisable(true);    }    @FXML    void ricercaAutoreEAnno(ActionEvent event)    {        tipoDiRicerca = TipoDiRicerca.AUTORE_E_ANNO;        tipiDiRicerca.setText("Autore e anno");        tfRicercaAnno.setDisable(false);    }    //ricerca del libro    @FXML    void btnClickResearch(ActionEvent event)    {        listaLibri.getItems().clear();        listLabel.setText("");        List<Book> libri = null;        btnInfoLibro.setVisible(false);        if(tfRicerca.getText().isEmpty())        {            errorLabel.setText("Ricerca non valida");            return;        }        try        {            if (tipoDiRicerca == TipoDiRicerca.TITOLO)            {                libri = App.getInstance().bookRepository.cercaLibroPerTitolo(tfRicerca.getText());            }            else if (tipoDiRicerca == TipoDiRicerca.AUTORE)            {                libri = App.getInstance().bookRepository.cercaLibroPerAutore(tfRicerca.getText());            }            else if (tipoDiRicerca == TipoDiRicerca.AUTORE_E_ANNO)            {                int anno = 0;                try                {                    anno = Integer.parseInt(tfRicercaAnno.getText());                }                catch (NumberFormatException e)                {                    listaLibri.getItems().clear();                    errorLabel.setText("L'anno cercato non è valido!");                    return;                }                if (anno < 0 || anno > LocalDate.now().getYear())                {                    listaLibri.getItems().clear();                    errorLabel.setText("L'anno cercato non è valido!");                    return;                }                libri = App.getInstance().bookRepository.cercaLibroPerAutoreEAnno(tfRicerca.getText(), anno);            }            errorLabel.setText("");        }        catch (RemoteException e)        {            listaLibri.getItems().clear();            errorLabel.setText("C'è stato un errore durante la ricerca!");            e.printStackTrace();            return;        }        if (libri == null || libri.isEmpty())        {            listaLibri.getItems().clear();            errorLabel.setText("Nessun libro trovato");            return;        }        ricercaLibriMap.clear();        libri.forEach(l -> {            ricercaLibriMap.put(l.toStringInfo(), l);        });        listaLibri.setItems(            FXCollections.observableArrayList(                libri.stream()                    .map(Book::toStringInfo)                    .collect(Collectors.toList())            )        );        listaLibri.getSelectionModel().selectedItemProperty().addListener(new ChangeListener<String>() {            @Override            public void changed(ObservableValue<? extends String> observableValue, String s, String t1)            {                libro = ricercaLibriMap.get(listaLibri.getSelectionModel().getSelectedItem());                if (LibreriaController.consigliando)                {                    btnInfoLibro.setVisible(false);                    btnConsigliaLibro.setVisible(true);                }                else {                    btnInfoLibro.setVisible(true);                }            }        });    }    @FXML    void btnClickInfoLibro(ActionEvent event)    {        App.getInstance().changeScene("InformazioniLibro.fxml");    }    @FXML void consigliaLibro() throws RemoteException    {        AddSuggestionResult result = App.getInstance().authedBookRepository.inserisciSuggerimentoLibro(LibreriaController.libro.id, libro.id);        if(result == AddSuggestionResult.OK)        {            LibreriaController.consigliando = false;            App.getInstance().changeScene("Libreria.fxml");        }        else if (libro.id == LibreriaController.libroConsigliato.id)        {            errorLabel.setText("non si puo consigliare lo stesso libro");        }        else if(result == AddSuggestionResult.ALREADY_SUGGESTED)        {            errorLabel.setText(result.getMessage());        }        else if (result == AddSuggestionResult.MAIN_BOOK_NOT_IN_LIBRARY)        {            errorLabel.setText(result.getMessage());        }        else if(result == AddSuggestionResult.SUGGESTED_BOOK_NOT_IN_LIBRARY)        {            errorLabel.setText(result.getMessage());        }        else if(result == AddSuggestionResult.TOO_MANY_SUGGESTIONS)        {            errorLabel.setText(result.getMessage());        }        else        {            errorLabel.setText(result.getMessage());        }    }    @FXML    void btnClickReturn(ActionEvent event)    {        LibreriaController.consigliando = false;        App.getInstance().changeScene("Libreria.fxml");    }    //bottoni di navigazione se si è ospite    @FXML    void accedi(ActionEvent event) throws IOException    {        App m = App.getInstance();        m.changeScene("Login.fxml");    }    @FXML    void registrati(ActionEvent event) throws IOException    {        App m = App.getInstance();        m.changeScene("Registrazione.fxml");    }    //bottoni di navigazione se si è registrato    @FXML    void btnClickCreaLib(ActionEvent event) throws IOException    {        App.getInstance().changeScene("CreaLibreria.fxml");    }    @FXML    void btnClickLeTueLib(ActionEvent event) throws IOException    {        App.getInstance().changeScene("LibrerieUtente.fxml");    }    @FXML    void btnClickLogout(ActionEvent event) throws IOException    {        LoginController.user = Utente.OSPITE;        App.getInstance().authedBookRepository.logout();        App.getInstance().changeScene("Benvenuto.fxml");    }}