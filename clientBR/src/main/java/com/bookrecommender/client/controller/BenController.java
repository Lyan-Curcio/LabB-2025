package com.bookrecommender.client.controller;import java.io.IOException;import java.rmi.RemoteException;import java.time.LocalDate;import java.util.HashMap;import java.util.List;import java.util.stream.Collectors;import com.bookrecommender.common.dto.Book;import com.bookrecommender.common.enums.suggestion.AddSuggestionResult;import javafx.beans.value.ChangeListener;import javafx.beans.value.ObservableValue;import javafx.collections.FXCollections;import javafx.event.ActionEvent;import javafx.fxml.FXML;import javafx.scene.control.*;import javafx.scene.layout.VBox;/** * Controller della schermata principale (Benvenuto/Ricerca libri). * <p> *   Gestisce la ricerca dei libri per titolo, autore o autore+anno. * </p> */public class BenController {    /** Contenitore dei pulsanti laterali */    @FXML private VBox buttonList;    /** Pulsanti di accesso e registrazione */    @FXML private Button btnAcc, btnReg;    /** Pulsanti per librerie, logout e ritorno */    @FXML private Button btnLeTueLib, btnLogout, btnRitorno;    /** Campo di testo per la ricerca principale */    @FXML private TextField tfRicerca;    /** Campo di testo per l'anno */    @FXML private TextField tfRicercaAnno;    /** Menu per selezionare il tipo di ricerca */    @FXML private SplitMenuButton tipiDiRicerca;    /** Label informativi e di errore */    @FXML private Label listLabel, errorLabel;    /** Lista dei libri trovati */    @FXML private ListView<String> listaLibri;    /** Pulsanti di azione sul libro selezionato */    @FXML private Button btnInfoLibro, btnConsigliaLibro;    /** Libro attualmente selezionato */    public static Book libro;    /**     * HashMap di supporto alla ricerca che associa la stringa visualizzata     * all'oggetto {@link Book} reale.     */    private HashMap<String, Book> ricercaLibriMap = new HashMap<>();    /**     * Metodo di inizializzazione del controller.     * <p>     * Viene eseguito automaticamente al caricamento dell'FXML.     * Si occupa di:     * <ul>     *   <li>configurare la ListView</li>     *   <li>impostare la UI in base allo stato dell'utente</li>     * </ul>     */    @FXML    private void initialize() {        btnInfoLibro.setVisible(false);        tfRicerca.setPromptText("scrivi titolo");        // Configurazione delle celle per permettere il ritorno a capo del testo        listaLibri.setCellFactory(param -> new ListCell<String>() {            @Override            protected void updateItem(String item, boolean empty) {                super.updateItem(item, empty);                if (empty || item == null) {                    setText(null);                    setGraphic(null);                } else {                    setText(item);                    setWrapText(true);                    setPrefWidth(0);                    maxWidthProperty().bind(listaLibri.widthProperty().subtract(20));                }            }        });        // Configurazione UI in base al tipo di utente        if (LoginController.user == Utente.REGISTRATO) {            listLabel.setText("Utente: " + LoginController.userId);            buttonList.getChildren().removeAll(btnAcc, btnReg);        } else {            listLabel.setText("Ospite");            buttonList.getChildren().removeAll(btnLeTueLib, btnLogout, btnRitorno);        }        // Modalità suggerimento libro        if (LibreriaController.consigliando) {            buttonList.getChildren().removeAll(btnLeTueLib, btnLogout);        } else {            buttonList.getChildren().removeAll(btnRitorno);        }    }    /**     * Tipologie di ricerca disponibili.     */    private enum TipoDiRicerca {        /** Ricerca per titolo */        TITOLO,        /** Ricerca per autore */        AUTORE,        /** Ricerca per autore e anno di pubblicazione */        AUTORE_E_ANNO    }    /** Tipo di ricerca selezionato (inizializzata a {@code TITOLO}) */    private TipoDiRicerca tipoDiRicerca = TipoDiRicerca.TITOLO;    /**     * Imposta la ricerca per autore.     *     * @param event evento di click     */    @FXML    void ricercaAutore(ActionEvent event) {        tipoDiRicerca = TipoDiRicerca.AUTORE;        tfRicerca.setPromptText("scrivi autore");        tipiDiRicerca.setText("Autore");        tfRicercaAnno.setDisable(true);    }    /**     * Imposta la ricerca per titolo.     *     * @param event evento di click     */    @FXML    void ricercaTitolo(ActionEvent event) {        tipoDiRicerca = TipoDiRicerca.TITOLO;        tfRicerca.setPromptText("scrivi titolo");        tipiDiRicerca.setText("Titolo");        tfRicercaAnno.setDisable(true);    }    /**     * Imposta la ricerca per autore e anno.     *     * @param event evento di click     */    @FXML    void ricercaAutoreEAnno(ActionEvent event) {        tipoDiRicerca = TipoDiRicerca.AUTORE_E_ANNO;        tfRicerca.setPromptText("scrivi autore");        tipiDiRicerca.setText("Autore e anno");        tfRicercaAnno.setDisable(false);    }    /**     * Avvia la ricerca dei libri in base ai parametri inseriti.     * <p>     *     Gestisce anche la validazione degli input e la visualizzazione degli errori.     * </p>     *     * @param event evento di click     */    @FXML    void btnClickResearch(ActionEvent event) {        listaLibri.getItems().clear();        btnInfoLibro.setVisible(false);        if (tfRicerca.getText().isEmpty()) {            errorLabel.setText("Ricerca non valida");            return;        }        List<Book> libri;        try {            if (tipoDiRicerca == TipoDiRicerca.TITOLO) {                libri = App.getInstance().bookRepository                    .cercaLibroPerTitolo(tfRicerca.getText());            } else if (tipoDiRicerca == TipoDiRicerca.AUTORE) {                libri = App.getInstance().bookRepository                    .cercaLibroPerAutore(tfRicerca.getText());            } else {                int anno;                try {                    anno = Integer.parseInt(tfRicercaAnno.getText());                } catch (NumberFormatException e) {                    errorLabel.setText("L'anno cercato non è valido!");                    return;                }                if (anno < 0 || anno > LocalDate.now().getYear()) {                    errorLabel.setText("L'anno cercato non è valido!");                    return;                }                libri = App.getInstance().bookRepository                    .cercaLibroPerAutoreEAnno(tfRicerca.getText(), anno);            }            errorLabel.setText("");        } catch (RemoteException e) {            errorLabel.setText("C'è stato un errore durante la ricerca!");            e.printStackTrace();            return;        }        if (libri == null || libri.isEmpty()) {            errorLabel.setText("Nessun libro trovato");            return;        }        ricercaLibriMap.clear();        libri.forEach(l -> ricercaLibriMap.put(l.toStringInfo(), l));        listaLibri.setItems(FXCollections.observableArrayList(            libri.stream()                .map(Book::toStringInfo)                .collect(Collectors.toList())        ));        // Listener sulla selezione del libro        listaLibri.getSelectionModel().selectedItemProperty()            .addListener(new ChangeListener<String>() {                @Override                public void changed(ObservableValue<? extends String> obs,                                    String oldValue, String newValue) {                    if (newValue == null) return;                    libro = ricercaLibriMap.get(newValue);                    if (LibreriaController.consigliando) {                        btnInfoLibro.setVisible(false);                        btnConsigliaLibro.setVisible(true);                    } else {                        btnInfoLibro.setVisible(true);                    }                }            });    }    /**     * Apre la schermata con le informazioni del libro selezionato.     *     * @param event evento di click     */    @FXML    void btnClickInfoLibro(ActionEvent event) {        App.getInstance().changeScene("InformazioniLibro.fxml");    }    /**     * Inserisce un libro consigliato a un altro libro.     * <p>     *     Questo pulsante è visibile solo se si sta selezionando un libro da consigliare.     * </p>     *     * @throws RemoteException in caso di errore di comunicazione     */    @FXML    void consigliaLibro() throws RemoteException {        AddSuggestionResult result =            App.getInstance().authedBookRepository                .inserisciSuggerimentoLibro(                    LibreriaController.libro.id, libro.id);        if (result == AddSuggestionResult.OK) {            LibreriaController.consigliando = false;            App.getInstance().changeScene("Libreria.fxml");        } else {            errorLabel.setText(result.getMessage());        }    }    /**     * Ritorna alla schermata della libreria.     *     * @param event evento di click     */    @FXML    void btnClickReturn(ActionEvent event) {        LibreriaController.consigliando = false;        App.getInstance().changeScene("Libreria.fxml");    }    /**     * Porta alla schermata di login.     *     * @param event evento di click     */    @FXML    void accedi(ActionEvent event) {        App.getInstance().changeScene("Login.fxml");    }    /**     * Porta alla schermata di registrazione.     *     * @param event evento di click     */    @FXML    void registrati(ActionEvent event) {        App.getInstance().changeScene("Registrazione.fxml");    }    /**     * Apre la schermata delle librerie dell'utente.     *     * @param event evento di click     */    @FXML    void btnClickLeTueLib(ActionEvent event) {        App.getInstance().changeScene("LibrerieUtente.fxml");    }    /**     * Effettua il logout dell'utente e ritorna alla schermata iniziale.     *     * @param event evento di click     * @throws RemoteException in caso di errore di comunicazione     */    @FXML    void btnClickLogout(ActionEvent event) throws RemoteException {        LoginController.user = Utente.OSPITE;        App.getInstance().authedBookRepository.logout();        App.getInstance().changeScene("Benvenuto.fxml");    }}